

## ‚úÖ **–ü–û–õ–ù–´–ô –ê–ù–ê–õ–ò–ó: –ö–∞–∫ —Ä–∞–∑–ª–∏—á–∏—Ç—å –ø–ª–∞—Ç–µ–∂–∏ —Å –ª–µ–Ω–¥–∏–Ω–≥–∞ –æ—Ç –ø–æ–¥–ø–∏—Å–æ—á–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π**

–Ø –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª –æ–±–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –∏ –≤—ã—è–≤–∏–ª –ø–æ–ª–Ω—É—é –∫–∞—Ä—Ç–∏–Ω—É —Å–∏—Å—Ç–µ–º—ã –ø–ª–∞—Ç–µ–∂–µ–π. –í–æ—Ç –∫–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:

---

## üîó **1. –°–¢–†–£–ö–¢–£–†–ê –°–°–´–õ–û–ö –ù–ê –õ–ï–ù–î–ò–ù–ì–ï**

### **–¢–µ–∫—É—â–∏–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —Å—Å—ã–ª–∫–∏ (–∏–∑ `school_landing/index.html`):**

```javascript
const tariffLinks = {
    // –ì—Ä—É–ø–ø–æ–≤—ã–µ –∑–∞–Ω—è—Ç–∏—è
    groupsMonthly: 'https://t.me/teleengbot?start=pr_162',      // –ï–∂–µ–º–µ—Å—è—á–Ω–∞—è –æ–ø–ª–∞—Ç–∞
    groupsOnetime: 'https://t.me/teleengbot?start=pr_163',       // –ï–¥–∏–Ω–æ—Ä–∞–∑–æ–≤—ã–π –ø–ª–∞—Ç—ë–∂
    groupsInstallment: 'https://t.me/teleengbot?start=pr_164',   // –†–∞—Å—Å—Ä–æ—á–∫–∞
    
    // –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –∑–∞–Ω—è—Ç–∏—è
    indivMonthly: 'https://t.me/teleengbot?start=pr_159',        // –ï–∂–µ–º–µ—Å—è—á–Ω–∞—è –æ–ø–ª–∞—Ç–∞
    indivOnetime: 'https://t.me/teleengbot?start=pr_160',        // –ï–¥–∏–Ω–æ—Ä–∞–∑–æ–≤—ã–π –ø–ª–∞—Ç—ë–∂
    indivInstallment: 'https://t.me/teleengbot?start=pr_161'     // –†–∞—Å—Å—Ä–æ—á–∫–∞
};
```

### **–°—Ç–∞—Ä—ã–µ —Å—Å—ã–ª–∫–∏ (–∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã, –Ω–æ –≤–∏–¥–Ω—ã –≤ HTML):**
- `pr_129`, `pr_127`, `pr_128` (–≥—Ä—É–ø–ø–æ–≤—ã–µ)
- `pr_119`, `pr_125`, `pr_126` (–∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ)

---

## üéØ **2. –ö–ê–ö –†–ê–ë–û–¢–ê–ï–¢ –ü–†–û–¶–ï–°–° –û–ü–õ–ê–¢–´**

### **–®–∞–≥ 1: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –ø–æ —Å—Å—ã–ª–∫–µ —Å –ª–µ–Ω–¥–∏–Ω–≥–∞**
```
https://t.me/teleengbot?start=pr_162
                               ‚Üì
                         preset_rate_id = 162
```

### **–®–∞–≥ 2: –ë–æ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–æ–º–∞–Ω–¥—É `/start pr_162`**
–§–∞–π–ª: `code/core/processors/mixins/admin/commands.py`, —Å—Ç—Ä–æ–∫–∏ 742-757

```python
case "pr":
    preset_rate = PresetRate.objects.filter(pk=arg[0]).last()  # pk = 162
    preset = preset_rate.preset
    self.check_and_start_trial(preset_rate, force=True)
    thread_user.preset_rate = preset_rate
    thread_user.preset = preset
    thread_user.save()
```

### **–®–∞–≥ 3: –°–æ–∑–¥–∞–µ—Ç—Å—è –ø–ª–∞—Ç–µ–∂ —Å –¥–∞–Ω–Ω—ã–º–∏**
–§–∞–π–ª: `code/core/utils/user.py`, —Å—Ç—Ä–æ–∫–∏ 215-229 –∏ 558-572

```python
data = {
    "pay_interval": preset_rate.pay_interval or "1 month",
    "pay_money_balance": preset_rate.pay_money_balance,
    "user_id": user.id,
    "username": user.username,
    "last_name": user.last_name,
    "first_name": user.first_name,
    "service_comment": f"{user.billing_tags} #pr_{preset_rate.pk} #p_{preset_rate.preset.pk} pr: {preset_rate.billing_tags}",
    "sub_service": user.subscription_type,
    "bot_id": bot.pk,
    "preset_rate_id": preset_rate.pk,  # ‚Üê –ö–õ–Æ–ß–ï–í–û–ï –ü–û–õ–ï!
    "need_create_club": True,
    "repay_url": f"https://t.me/{bot.username}?start=repay",
}
```

### **–®–∞–≥ 4: –ü–ª–∞—Ç–µ–∂ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ `billing_payments`**
```sql
INSERT INTO billing_payments (
    service,           -- "b_1" (bot_id)
    status,            -- "waiting"
    data,              -- JSON —Å preset_rate_id –∏ –¥—Ä—É–≥–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏
    account_id,        -- telegram_id –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    ...
)
```

---

## üîç **3. –ö–ê–ö –†–ê–ó–õ–ò–ß–ò–¢–¨ –ü–õ–ê–¢–ï–ñ–ò –í –ë–ê–ó–ï –î–ê–ù–ù–´–•**

### **üü¢ –ü–ª–∞—Ç–µ–∂–∏ —Å –õ–ï–ù–î–ò–ù–ì–ê (–ø–µ—Ä–≤–∞—è –æ–ø–ª–∞—Ç–∞ —Å —Å–∞–π—Ç–∞):**

```python
# –ü—Ä–∏–∑–Ω–∞–∫–∏:
payment.data['preset_rate_id']  # –í–°–ï–ì–î–ê –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç (159-164)
payment.data['service_comment'] # –°–æ–¥–µ—Ä–∂–∏—Ç "#pr_{preset_rate_id}"
payment.data['need_create_club'] # = True
payment.service                  # = "b_{bot_id}" (–Ω–∞–ø—Ä–∏–º–µ—Ä "b_1")
payment.status                   # = "completed"
```

**–ü—Ä–∏–º–µ—Ä `service_comment` —Å –ª–µ–Ω–¥–∏–Ω–≥–∞:**
```
"#a123456789 #pr_162 #p_10 pr: "
     ‚Üë          ‚Üë       ‚Üë
  user_id  preset_rate preset
```

### **üîµ –ü–ª–∞—Ç–µ–∂–∏ –ø–æ –ü–û–î–ü–ò–°–ö–ï (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ):**

```python
# –ü—Ä–∏–∑–Ω–∞–∫–∏:
payment.data['preset_rate_id']  # –¢–æ–∂–µ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç (—Å—Ç–∞—Ä—ã–π preset_rate)
payment.data['service_comment'] # –°–æ–¥–µ—Ä–∂–∏—Ç "#charge"
payment.service                  # = "b_{bot_id}"
payment.payment_method          # ‚â† NULL (—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–∞—è –∫–∞—Ä—Ç–∞)
```

**–ü—Ä–∏–º–µ—Ä `service_comment` –ø–æ–¥–ø–∏—Å–∫–∏:**
```
"#a123456789 #charge billing_tags pr: preset_rate_billing_tags"
     ‚Üë          ‚Üë
  user_id    –∞–≤—Ç–æ—Å–ø–∏—Å–∞–Ω–∏–µ
```

### **üü° –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏ (—Ä—É—á–Ω–æ–µ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞):**

```python
# –ü—Ä–∏–∑–Ω–∞–∫–∏:
payment.data['service_comment'] # –°–æ–¥–µ—Ä–∂–∏—Ç "#additional"
payment.data['is_additional_payment'] # = True
```

---

## üìä **4. SQL –ó–ê–ü–†–û–°–´ –î–õ–Ø –ê–ù–ê–õ–ò–¢–ò–ö–ò**

### **–í—Å–µ –ø–ª–∞—Ç–µ–∂–∏ —Å –ª–µ–Ω–¥–∏–Ω–≥–∞ (—Ç–µ–∫—É—â–∏–µ —Ç–∞—Ä–∏—Ñ—ã):**
```sql
SELECT 
    id,
    account_id,
    data->>'preset_rate_id' as preset_rate_id,
    data->>'service_comment' as service_comment,
    price_rub,
    price_eur,
    price_usd,
    status,
    created_at
FROM billing_payments
WHERE 
    data->>'preset_rate_id' IN ('159', '160', '161', '162', '163', '164')
    AND status = 'completed'
    AND created_at >= CURRENT_DATE
ORDER BY created_at DESC;
```

### **–ü–ª–∞—Ç–µ–∂–∏ –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É —Ç–∞—Ä–∏—Ñ—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –µ–∂–µ–º–µ—Å—è—á–Ω–æ):**
```sql
SELECT 
    id,
    account_id,
    data->>'preset_rate_id' as preset_rate_id,
    price_eur,
    status,
    created_at
FROM billing_payments
WHERE 
    data->>'preset_rate_id' = '159'  -- indivMonthly
    AND status = 'completed'
ORDER BY created_at DESC;
```

### **–í—Å–µ –ø–ª–∞—Ç–µ–∂–∏ —Å –ª–µ–Ω–¥–∏–Ω–≥–∞ (–ª—é–±—ã–µ —Ç–∞—Ä–∏—Ñ—ã):**
```sql
SELECT 
    id,
    account_id,
    data->>'preset_rate_id' as preset_rate_id,
    data->>'service_comment' as comment,
    price_rub,
    price_eur,
    status,
    created_at
FROM billing_payments
WHERE 
    data->>'service_comment' LIKE '%#pr_%'  -- –ú–∞—Ä–∫–µ—Ä –ª–µ–Ω–¥–∏–Ω–≥–æ–≤–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞
    AND data->>'need_create_club' = 'true'  -- –ü–µ—Ä–≤–∞—è –æ–ø–ª–∞—Ç–∞
    AND status = 'completed'
ORDER BY created_at DESC;
```

### **–ü–æ–¥–ø–∏—Å–æ—á–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏ (–∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ):**
```sql
SELECT 
    id,
    account_id,
    payment_method_id,
    data->>'service_comment' as comment,
    price_rub,
    price_eur,
    status,
    created_at
FROM billing_payments
WHERE 
    data->>'service_comment' LIKE '%#charge%'  -- –ê–≤—Ç–æ—Å–ø–∏—Å–∞–Ω–∏–µ
    AND status = 'completed'
    AND created_at >= CURRENT_DATE
ORDER BY created_at DESC;
```

### **–°—Ä–∞–≤–Ω–µ–Ω–∏–µ: –ª–µ–Ω–¥–∏–Ω–≥ VS –ø–æ–¥–ø–∏—Å–∫–∞ –∑–∞ —Å–µ–≥–æ–¥–Ω—è:**
```sql
-- –ü–ª–∞—Ç–µ–∂–∏ —Å –ª–µ–Ω–¥–∏–Ω–≥–∞
SELECT 
    'Landing' as source,
    COUNT(*) as count,
    SUM(CASE WHEN price_eur IS NOT NULL THEN price_eur ELSE 0 END) / 100.0 as total_eur,
    SUM(CASE WHEN price_rub IS NOT NULL THEN price_rub ELSE 0 END) / 100.0 as total_rub
FROM billing_payments
WHERE 
    data->>'service_comment' LIKE '%#pr_%'
    AND data->>'need_create_club' = 'true'
    AND status = 'completed'
    AND created_at >= CURRENT_DATE

UNION ALL

-- –ü–æ–¥–ø–∏—Å–æ—á–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏
SELECT 
    'Subscription' as source,
    COUNT(*) as count,
    SUM(CASE WHEN price_eur IS NOT NULL THEN price_eur ELSE 0 END) / 100.0 as total_eur,
    SUM(CASE WHEN price_rub IS NOT NULL THEN price_rub ELSE 0 END) / 100.0 as total_rub
FROM billing_payments
WHERE 
    data->>'service_comment' LIKE '%#charge%'
    AND status = 'completed'
    AND created_at >= CURRENT_DATE;
```

---

## üìã **5. –¢–ê–ë–õ–ò–¶–ê –°–û–û–¢–í–ï–¢–°–¢–í–ò–Ø –¢–ê–†–ò–§–û–í**

| –¢–∞—Ä–∏—Ñ | Landing Link | preset_rate_id | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------|--------------|----------------|----------|
| **–ì—Ä—É–ø–ø–æ–≤—ã–µ** | | | |
| –ï–∂–µ–º–µ—Å—è—á–Ω–∞—è –æ–ø–ª–∞—Ç–∞ | `pr_162` | 162 | 100‚Ç¨/–º–µ—Å (—Å–æ —Å–∫–∏–¥–∫–æ–π 50‚Ç¨) |
| –ï–¥–∏–Ω–æ—Ä–∞–∑–æ–≤—ã–π –ø–ª–∞—Ç—ë–∂ | `pr_163` | 163 | 75‚Ç¨/–º–µ—Å –∑–∞ 2 –≥–æ–¥–∞ |
| –†–∞—Å—Å—Ä–æ—á–∫–∞ | `pr_164` | 164 | 7500‚ÇΩ/–º–µ—Å |
| **–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ** | | | |
| –ï–∂–µ–º–µ—Å—è—á–Ω–∞—è –æ–ø–ª–∞—Ç–∞ | `pr_159` | 159 | 220‚Ç¨/–º–µ—Å (—Å–æ —Å–∫–∏–¥–∫–æ–π 110‚Ç¨) |
| –ï–¥–∏–Ω–æ—Ä–∞–∑–æ–≤—ã–π –ø–ª–∞—Ç—ë–∂ | `pr_160` | 160 | 165‚Ç¨/–º–µ—Å –∑–∞ 2 –≥–æ–¥–∞ |
| –†–∞—Å—Å—Ä–æ—á–∫–∞ | `pr_161` | 161 | 16500‚ÇΩ/–º–µ—Å |

---

## üéØ **6. –ö–õ–Æ–ß–ï–í–´–ï –û–¢–õ–ò–ß–ò–Ø –í –î–ê–ù–ù–´–•**

| –ü–æ–ª–µ | –õ–µ–Ω–¥–∏–Ω–≥ | –ü–æ–¥–ø–∏—Å–∫–∞ | –î–æ–ø. –ø–ª–∞—Ç—ë–∂ |
|------|---------|----------|-------------|
| `data.preset_rate_id` | ‚úÖ –í—Å–µ–≥–¥–∞ | ‚úÖ –î–∞ | ‚úÖ –î–∞ |
| `data.service_comment` | `#pr_{id}` | `#charge` | `#additional` |
| `data.need_create_club` | `true` | - | - |
| `payment_method` | –û–±—ã—á–Ω–æ NULL | ‚úÖ –ï—Å—Ç—å | –ú–æ–∂–µ—Ç –±—ã—Ç—å |
| `service` | `b_{bot_id}` | `b_{bot_id}` | `b_{bot_id}` |

---

## ‚ú® **7. –ò–¢–û–ì–û–í–´–ô –ê–õ–ì–û–†–ò–¢–ú –ò–î–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–ò**

```python
def identify_payment_source(payment):
    """
    –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∏—Å—Ç–æ—á–Ω–∏–∫ –ø–ª–∞—Ç–µ–∂–∞
    Returns: 'landing', 'subscription', 'additional', 'unknown'
    """
    service_comment = payment.data.get('service_comment', '')
    
    # 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–∞—Ä–∫–µ—Ä –ª–µ–Ω–¥–∏–Ω–≥–∞
    if '#pr_' in service_comment and payment.data.get('need_create_club'):
        preset_rate_id = payment.data.get('preset_rate_id')
        # –¢–µ–∫—É—â–∏–µ –ª–µ–Ω–¥–∏–Ω–≥–æ–≤—ã–µ —Ç–∞—Ä–∏—Ñ—ã
        if preset_rate_id in [159, 160, 161, 162, 163, 164]:
            return 'landing_current'
        else:
            return 'landing_old'
    
    # 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å–∫—É
    if '#charge' in service_comment:
        return 'subscription'
    
    # 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –ø–ª–∞—Ç—ë–∂
    if '#additional' in service_comment or payment.data.get('is_additional_payment'):
        return 'additional'
    
    return 'unknown'
```

---

## üöÄ **–í–´–í–û–î**

**–ì–ª–∞–≤–Ω—ã–π —Å–ø–æ—Å–æ–± —Ä–∞–∑–ª–∏—á–∏—Ç—å –ø–ª–∞—Ç–µ–∂–∏:**

1. **–ü–ª–∞—Ç–µ–∂–∏ —Å –õ–ï–ù–î–ò–ù–ì–ê** = `data.service_comment` —Å–æ–¥–µ—Ä–∂–∏—Ç `#pr_{id}` + `data.need_create_club = true`
2. **–ü–æ–¥–ø–∏—Å–æ—á–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏** = `data.service_comment` —Å–æ–¥–µ—Ä–∂–∏—Ç `#charge` + –µ—Å—Ç—å `payment_method`
3. **–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ** = `data.service_comment` —Å–æ–¥–µ—Ä–∂–∏—Ç `#additional`

**–î–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –ø–æ –ª–µ–Ω–¥–∏–Ω–≥—É** —Å–º–æ—Ç—Ä–∏—Ç–µ –Ω–∞ `data.preset_rate_id` —Å–æ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ **159-164** (—Ç–µ–∫—É—â–∏–µ —Ç–∞—Ä–∏—Ñ—ã).

–¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ —Ç–æ—á–Ω–æ –æ—Ç–¥–µ–ª–∏—Ç—å —Ç–µ—Ö, –∫—Ç–æ –æ–ø–ª–∞—á–∏–≤–∞–µ—Ç —Å –ª–µ–Ω–¥–∏–Ω–≥–∞, –æ—Ç —Ç–µ—Ö, –∫—Ç–æ —Å–æ–≤–µ—Ä—à–∞–µ—Ç –ø–ª–∞—Ç–µ–∂–∏ –ø–æ –ø–æ–¥–ø–∏—Å–∫–µ! üéâ